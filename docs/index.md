# Hello World

⛅️♥️🌀💪💦🎧🙇🚣🔁🎯🍪▼👇❗✍️📁🚀🔥⚠️🌐🚨🙌🛡️🌟🏆🧩🛡️🔔⏱️🗃️⚛️📣🤝🏗️ 🧭🪜 ⭕️🔚💬🔜📌👑 ❓✨❌🥇🥈🥉🛠📊⚙️ 🧪🧠🔧✔✅🚫🔍🧭 🧱
💥

以下に、人事情報受信処理の業務フローを集約・整理しました。主要な処理ステップと注意点を明確に示しています。

### 人事情報受信処理 業務フロー概要

#### 1. 事前準備

- **必須ファイル**：6 種類の CSV（組織/店部課/社員/AD 情報/機構改革/終了フラグ）
- **運用側作業**：
  - 除外役職情報登録（`exclude_executive`テーブル）
  - ダミー情報整備（`DUM_ORGANIZATION`/`DUM_DEPARTMENT`/`DUM_EMPLOYEE`）
  - 閾値設定（`THRESHOLD`テーブル）

#### 2. 処理フロー

1. **ファイル受信チェック**

   - 早朝 6 時に Hulft 転送を確認
   - 必須 6 ファイル欠損時は即時エラー

2. **ロック処理**

   - 二重実行防止のためロックファイル作成

3. **データ取込（全件置換）**
   | CSV ファイル | 対象テーブル | 特別処理内容 |
   |---------------------|---------------------|------------------------------------------------------------------------------|
   | organization.csv | BIZ_ORGANIZATION | ダミー組織除外 |
   | department.csv | BIZ_DEPARTMENT | 会社コード 001/002 以外除外 + ダミー店部課除外 |
   | employee.csv | BIZ_EMPLOYEE | 会社コード制限 + ダミー社員 + 除外役職コード除外 |
   | ad.csv | BIZ_AD | ログオン名 10 桁時は末尾 7 桁使用（重複時は後勝ち） |
   | shift.csv | BIZ_SHIFT | 存在時のみ取込 |
   | EOFAD/EOFAM | - | 処理終了フラグ |

4. **データ整合性処理**

   - **閾値チェック**：入社数 + 退社数 + 異動数が閾値超過時はロールバック
   - **店部課マスタ同期**：
     - 新規店部課追加（`M_SECTION`）
     - 既存店部課情報更新（名称/親 ID/組織コード/表示順）
   - **社員ステータス管理**：
     - 退社処理（4 テーブルの削除フラグ更新）
     - 入社処理（`APP_USER`への新規登録）
     - 社員情報更新（社員区分/氏名/生年月日など）

5. **組織変更対応**
   - **拠点統廃合**：
     1. 廃止店部課のユーザー/電話機を新部署に移行
     2. 関連リソース更新（CallingSearchSpace/PickupGroup/課金先）
   - **所属管理**：
     - 新規所属追加（入社/転勤/兼務対応）
     - 所属変更（店部課名変更時）
     - 転出元所属削除（電話機未紐付時は物理削除）

#### 3. 終了処理

- **正常時**：
  - CSV ファイルをリネーム（`_IMPORTED_YYYYMMDDHH24MISS`）
  - トランザクションコミット
  - ロックファイル削除
- **異常時**：
  - 全処理ロールバック（前日状態に復旧）
  - エラーログ出力

#### 4. 出力物

- **退職者一覧**：`retired_users_YYYY-MM-DD.log`
  ```sql
  SELECT 姓, 名, 電話番号, 姓名結合ID
  FROM APP_USER
  WHERE DELETED = '1'
  ORDER BY 電話番号
  ```

### 特別注意点

1. **全件置換方式**：

   - 毎回テーブル全削除 → 再登録のため、CSV は完全なデータセットが必要
   - ダミーデータ除外は取込後に実施

2. **エラー処理**：

   - CSV 形式不正や閾値超過時は即時中止
   - メール通知による異常検知

3. **手動実行**：

   - 定期バッチ（日次）以外にシェル起動で随時実行可能

4. **パフォーマンス**：
   - 大規模データ対応のため、閾値管理を実施
   - バッチ処理時間帯を考慮（通常は深夜帯実行）

> この処理は人事システムと統合 ID システムの重要な連携ポイントであり、組織変更や人事異動がアプリケーション上で正しく反映されることを保証します。特に機構改革時の拠点統廃合処理では、電話機や課金情報など複数の関連リソースが自動更新されることが特徴です。
